---
title: "Functions and Tidy Data"
author: "Robert Bartolini"
date: "10/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(reactable)
```
https://github.com/rjmaitri/04_Bartolini_Bob_2020.git

Functions and Tidy Data
Biol 607
10/4/2020


## 1. Write a function that takes a vector and returns one bootstrapped sample from said vector. Demonstrate that it works.

```{r}



# One Bootsrap Sample ####
bootstrap <- function(vec){
  
  one_boot<- sample(vec,
                   size = length(vec),
                   replace = TRUE)

  
  return(one_boot)
}

bootstrap(c(1,4,5))



```


## 2. Write a function that given a vector of values, a request for some number of bootstraps (let’s call the parameter R), and a sample statistic function (e.g., mean, IQR, etc.) returns R number of values of that statistic. Have it default to R = 1000 and the function is mean. Show this works for 10 bootstrapped replicate draws of a mean from some vector. Do the values look reasonable? Compare to the actual mean of the vector.

make sure you are using the function(s) you wrote in #1


```{r}
library(dplyr)
#input vec, R(#of bootstraps), mean
#default to 1k= R

bootstrap <- function(vec){
  
  one_boot<- sample(vec,
                   size = length(vec),
                   replace = TRUE)

  
  return(one_boot)
}

boot_mean <- function(vec, R = 1000, fun = mean) {

out <- replicate(R, bootstrap(vec))


fun(out)

}

boot_mean(c(3,4,5,3,2,50),10)


#compare to actual mean of vector
mean(c(3,4,5,3,2))

data.frame(R = 1:10) %>%
  rowwise(R) %>%
  summarize(boot_mean(c(3,4,5,3,2,50),10, fun = mean)) 



```


## 3. Write a function that, given a vector of values, a request for some number of bootstraps, and a sample statistic function, returns the original value of the statistic as applied to the vector, the mean of the statistic generated by the bootstrapped reps, the upper and lower 95% CI of the bootstrapped statistic (e.g., the 0.025 and 0.975 quantile), and the bias (i.e., the original value of the statistic - the mean of the bootstrapped statistic).


```{r}

##with functions
bootstrap <- function(vec){
  
  one_boot<- sample(vec,
                   size = length(vec),
                   replace = TRUE)

  
  return(one_boot)
}

boot_mean <- function(vec, R = 1000, fun = mean) {

out <- replicate(R, bootstrap(vec))


fun(out)

}

boot_mean(c(3,4,5,3,2,50),10)


#compare to actual mean of vector
mean(c(3,4,5,3,2))

stats_Bootsfunc <- function(vec, R = 1000, fun = mean){

vals <- replicate(R, bootstrap(vec))
  
bstraps_mean <- mean(vals)
mean_vec <- mean(vec)
firstquant <- quantile(vals,0.025)
thirdquant <- quantile(vals,0.975)
bias <- mean(vec) - mean(vals)
  
out <- data.frame(mean_vec = mean_vec,  
        mean_samp = bstraps_mean,
    firstquantile = firstquant,
    thirdquantile = thirdquant,
    bias = bias)

return(out)
}

stats_Bootsfunc(c(4,5,2,2,3,2,4,16,8,9,9,19,8,32,32,32,32,41,4,8,4,5),1)

reactable(data.frame(R = 1:100) %>%
  rowwise(R) %>%
  summarize(stats_Bootsfunc(c(3,4,5,5,5,6,5,10,4,5,4,4,16,8,9,9,19,18,20,21,22,4,8,4,5,5,6,5,6,4),R=100, fun = mean))) 

```

4. FiveThirtyEight keeps a great archive of poll data at https://projects.fivethirtyeight.com/polls/. The presidential general election polling data is freely available at https://projects.fivethirtyeight.com/polls-page/president_polls.csv with question, poll id, and cycle defining a unique poll.

    4a. Download and look at the data. Is it long or wide?

```{r}
library(readr)
pres_poll <- read_csv("president_polls.csv")

reactable(pres_poll)
```


<span style="color: green;"> The presidential polls dataset is long, as it has two rows dedicated to each polling question.</span>

    4b. Get just the polling data for this last week (from 9/29 to today). Filter on start_date. Also filter down to just Biden and Trump (see candidate_name or answer). Extra credit for using {lubridate} for this, but you can just do a messy %in% string match.
    
```{r}
library(lubridate)
library(dplyr)
library(readr)

class(pres_poll$start_date)

pres_poll$start_date<- as.Date(pres_poll$start_date, format = "%m/%d/%Y")



presPoll_filter <- filter(pres_poll, answer == "Biden" | answer == "Trump")
  
pres_current <- presPoll_filter[presPoll_filter$start_date >= "2020-09-29" & presPoll_filter$start_date <= "2020-10-10",]

reactable(pres_current)

```

    4c. OK, this is your sample. What’s the bootstrapped average percentage for each candidate for nationwide polls (state == "")? Note, this answer will not match 538 given their weighting by poll trustworthiness.
    
```{r}


#filter by president and nationwide
Boot_pct <- pres_current %>% 
  select(state, answer, pct)
#replace NA's with zeros to keep dpylr happy
vec_3 <- replace(Boot_pct$state, is.na(Boot_pct$state), 0)

data <- data.frame(Nationwide = c(vec_3),
                   Candidate = c(Boot_pct$answer),
                   pct = Boot_pct$pct)

#Trump & National Pct filter for bootstrap
trumpbootdata <- data %>%
  filter(Candidate == "Trump" & Nationwide == 0)

# SE of the mean ####
# SE of the mean ####
Donald_boot_mean <- sample(trumpbootdata$pct, 
                             size = length(trumpbootdata$pct),
                             replace = TRUE) %>% mean

```

```{r}

#Trump & National Pct filter for bootstrap
Bidenbootdata <- data %>%
  filter(Candidate == "Biden" & Nationwide == 0)

# SE of the mean ####
# SE of the mean ####
Biden_boot_mean <- sample(Bidenbootdata$pct, 
                             size = length(Bidenbootdata$pct),
                             replace = TRUE) %>% mean

```

    4d. What is the average difference between the two candidates by state and national polls? Note, you’ll need to make this a wide data frame to answer! And, well, try the pivot without this advice first, but then….
    
```{r}
library(tidyr)

poll_wide <- data %>%
  pivot_wider(names_from = Candidate,
              values_from = Nationwide, pct)


reactable(poll_wide)
```

### make a unique ID by pasting together the question_id, poll_id, and state. Then select the ID, state, answer, and pct. Also filter out NA diffs



```{r}




Tidy_polls <- pres_current %>%
mutate(unique_ID = paste(state, question_id, poll_id, sep = "_"))


Wide_N_Tidy <- replace(Boot_pct$state, is.na(Boot_pct$state), 0)

Wide_N_Tidy <- Tidy_polls %>%
  pivot_wider(names_from = answer,
              values_from = pct)  %>%
  select(state, Biden, Trump, unique_ID)

reactable(Wide_N_Tidy)

```

```{r}

####get the difference between Trump and Biden
Poll_diff <- Wide_N_Tidy %>%
    group_by(state) %>%
    arrange(unique_ID) %>%
    mutate(diff = Trump - lag(Biden)) 

reactable(Poll_diff)

#extract national data/create national df
National_diff <- Poll_diff[c(67:176),]

#make absolute values
National_diff <- abs(National_diff$diff)

#bootstrap an average national poll difference
USA_mean <- sample(na.omit(National_diff), 
       size = length(National_diff),
       replace = TRUE) %>% mean

#create state df by extracting national
State_diff <- Poll_diff[-c(67:176),]

#make absolute values
State_diff$diff <- abs(State_diff$diff)

#bootstrap state mean
State_mean <- sample(na.omit(State_diff), 
       size = length(State_diff),
       replace = TRUE) %>% mean

###### attempt to get means by EACH STATE
#bootstrap state mean
#State_mean <- na.omit(State_diff) %>%
#  group_by(state) %>%
#  sample(diff,
#       size = length(diff),
#       replace = TRUE) %>%
#     summarize(State = state,
#    mean = mean(diff),
#            SE = mean(diff)/sqrt(length(State_diff)-1))




```






5. replicate() has been our friend, but we’ve always had to be a little hacky with it. We’ve either had to fold in means, or use tricksy functions like colMeans and the like.

BUT - what’s interesting about replicate() is that, if you ask it to turn back raw draws from a random number generator - or anything with more than one value - it gives you a matrix or array.

    5a. So, I want you to, using the mean and SD of Biden’s national polling average (you’ll need to calculate it!) from above, simulate 1000 draws from that population with a sample size of 50. What are the dimensions of the object. What are in the rows and columns?
    
```{r}



```

    5b. Yuck. Can you turn this into something usable? Say, first make it a tibble or data frame, and then pivot it to long, such that you end up with a column that has an identifier for sim and a column with a single value from that sim?

(Oh, and for all columns, cols = everything())

    5c. For each sim, what’s the bootsrapped mean and CI? Plot it! And tell us how often it’s greater than the initial mean. E.C. for the plot showing the stats in order from low to high.

    5d. So…. what is that plot showing? What are the concepts involved?

EC 3 bonus point for each awesome quality visualization of the general polling data. There is a LOT there, so look carefully before you leap.